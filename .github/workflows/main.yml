name: "⚡ EnigMano Win11 Deployment Simplified"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"
      TAILSCALE_TAG:
        description: "Tailscale tag for this instance"
        required: false
        default: "enigmano-instance"

jobs:
  deploy-enigmano:
    name: "🚀 Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      TAILSCALE_TAG: ${{ github.event.inputs.TAILSCALE_TAG }}-${{ github.event.inputs.INSTANCE }}
      TAILSCALE_AUTHKEY: ""   # يمكن تركها فارغة إذا لم تستخدم Tailscale

    steps:
      - name: 📌 Deployment Parameters
        shell: pwsh
        run: |
          Write-Host "==============================================="
          Write-Host "🔹 EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "🏷️  Tailscale Tag        : $env:TAILSCALE_TAG"
          Write-Host "==============================================="

      - name: 📥 Install Tailscale (Optional)
        shell: pwsh
        run: |
          if ($env:TAILSCALE_AUTHKEY -ne "") {
            Write-Host "🔄 Installing Tailscale..."
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe" -UseBasicParsing
            Start-Process ".\tailscale-setup.exe" -ArgumentList "/S" -Wait
            Write-Host "✅ Tailscale installed"
          } else {
            Write-Host "⚠️ Skipping Tailscale installation"
          }

      - name: 🔗 Connect to Tailscale (Optional)
        shell: pwsh
        run: |
          if ($env:TAILSCALE_AUTHKEY -ne "") {
            Start-Service -Name "Tailscale"
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTHKEY --hostname=$env:TAILSCALE_TAG --accept-routes=true
            $tailscaleStatus = & "C:\Program Files\Tailscale\tailscale.exe" status --json
            $statusData = $tailscaleStatus | ConvertFrom-Json
            $tailscaleIP = $statusData.Self.TailscaleIPs[0]
            Write-Host "🌐 Tailscale IP: $tailscaleIP"
            echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
          } else {
            Write-Host "⚠️ Skipping Tailscale connection"
          }

      - name: 📥 Download EnigMano Script
        shell: pwsh
        run: |
          $url = "https://gitlab.com/Shahzaib-YT/enigmano-windows-11-with-sound/-/raw/main/EnigMano-Instance.ps1"
          Invoke-WebRequest -Uri $url -OutFile "EnigMano-Instance.ps1" -UseBasicParsing
          Write-Host "✅ EnigMano-Instance.ps1 downloaded"

      - name: ⚔️ Execute EnigMano Script
        shell: pwsh
        run: |
          Write-Host "🚦 Running EnigMano-Instance.ps1"
          powershell.exe -ExecutionPolicy Bypass -File ".\EnigMano-Instance.ps1"

      - name: 📋 Display Info
        shell: pwsh
        run: |
          Write-Host "==============================================="
          Write-Host "🔹 Instance ID: $env:INSTANCE_ID"
          if ($env:TAILSCALE_IP) { Write-Host "🔹 Tailscale IP: $env:TAILSCALE_IP" }
          Write-Host "==============================================="
